<!doctype html>
<html>
	<head>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- stylesheets -->
		<link rel="stylesheet" type="text/css" href="/assets/bootstrap.css"/>
		<link rel="stylesheet" type="text/css" href="/assets/dewey.css"/>

	</head>
	<body data-ng-app="DeweyApp">

		<!-- container -->
		<div id="main" class="container-fluid">
			<div class="col-xs-12" data-ng-view></div>
		</div>

		<!-- inline templates -->
		<script type="text/ng-template" id="/login">
			<div class="login col-xs-12">
				<img id="logo" class="col-xs-12" src="/assets/logo_transparent.png">
				<br>
				<span class="mission col-xs-12">find the right people</span>
				<br>
				<input type="email" class="form-control" id="email" name="email" placeholder="email" ng-model="loginData.email">
				<input type="password" class="form-control" id="password" name="password" placeholder="password" ng-model="loginData.password">
				<button type="button" class="col-xs-12 btn btn-default btn-lg" ng-click='login()'>login</button>
				<div class="col-xs-1"></div>
			</div>
		</script>
		<script type="text/ng-template" id="/search">
			<div ng-include src="'/navigation'"></div>
			<div ng-include src="'/list'"></div>
		</script>
		<script type="text/ng-template" id="/user">
			<div ng-include src="'/navigation'"></div>
			<div ng-include src="'/user_profile'"></div>
			<div ng-include src="'/tags'"></div>
		</script>
		<script type="text/ng-template" id="/topic">
			<div ng-include src="'/navigation'"></div>
			<div ng-include src="'/topic_profile'"></div>
			<div ng-include src="'/list'"></div>
		</script>
		<script type="text/ng-template" id="/navigation">
			<nav class="nav col-xs-12">
				<a href="#/search">
					<img id="logo" src="/assets/logo.png">
				</a>
				<div class="col-xs-10">
					<div class="col-xs-12 input-group input-group-lg">
					  <input id="search" type="text" class="form-control" placeholder="search by topic or person" ng-keyup="search()" ng-model="queryData.query">
					</div>
				</div>
			</nav>
		</script>
		<script type="text/ng-template" id="/list">
			<div class="list col-xs-12 list-group">
				<div ng-repeat="result in results">
				  <a href="#/{{ result.category }}/{{ result.id }}" class="list-group-item">
						<div class="circular-image" style="background-image:url('/assets/{{ result.image }}')"></div>
				  	<div class="col-xs-10 result-text-container">
					    <h4 class="list-group-item-heading">{{ result.first_name }}</h4>
					    <p class="list-group-item-text">{{ result.department }}</p>
				  	</div>
				  </a>
				</div>
			</div>
		</script>
		<script type="text/ng-template" id="/user_profile">
			<div class="profile col-xs-12">
				<div class="circular-image" style="background-image:url('/assets/{{ user.image }}')"></div>
				<div class="col-xs-12">
					<span class="name">{{ user.first_name }} {{ user.last_name }}</span>
					<br>
					<span class="description">{{ user.position }}</span>
					<br>
					<br>
					<span class="email">email: {{ user.email }}</span>
					<br>
					<span class="phone">phone: {{ user.phone }}</span>
				</div>
			</div>
		</script>
		<script type="text/ng-template" id="/topic_profile">
			<div class="profile col-xs-12">					
				<div class="circular-image" style="background-image:url('/assets/picture_placeholder.png')"></div>
				<div class="col-xs-12">
					<span class="name">{{ topic.title }}</span>
					<br>
					<span class="description">{{ topic.description }}</span>
				</div>
			</div>
		</script>
		<script type="text/ng-template" id="/tags">
			<div class="tags col-xs-12">
				<a ng-repeat="tag in topics" href="#/topics/{{ tag.id }}">{{ tag.title }}</a>
			</div>
		</script>

		<!-- javascripts -->
		<script src="/assets/angular.js"></script>
		<script src="/assets/angular-route.js"></script>
		<script src="/assets/jquery-1.11.0.js"></script>
		<script src="/assets/underscore.js"></script>

		<!-- Angular javascript -->
		<script>
			var DeweyApp = angular.module('DeweyApp', ['ngRoute']);

			DeweyApp.config(function ($routeProvider) {
			  $routeProvider
			    .when('/', {
			    	controller: 'DeweyController',
			    	templateUrl: '/login'
			    })
			    .when('/search', {
			    	redirectTo: '/search/_'
			    })
			    .when('/search/:query', {
			    	controller: 'DeweyController',
			    	templateUrl: '/search',
			    	resolve: {
			    		getResults: function (DeweyFactory) {
			    			return DeweyFactory.getResults();
			    		}
			    	}
			    })
			    .when('/users/:userId', {
			    	controller: 'DeweyController',
			    	templateUrl: '/user',
			    	resolve: {
			    		getUser: function (DeweyFactory) {
			    			return DeweyFactory.getUser();
			    		},
			    		getTopics: function (DeweyFactory) {
			    			return DeweyFactory.getTopics();
			    		},
			    		getLinks: function (DeweyFactory) {
			    			return DeweyFactory.getLinks();
			    		}
			    	}
			    })
			    .when('/topics/:topicId', {
			    	controller: 'DeweyController',
			    	templateUrl: '/topic',
			    	resolve: {
			    		getTopic: function (DeweyFactory) {
			    			return DeweyFactory.getTopic();
			    		},
			    		getUsers: function (DeweyFactory) {
			    			return DeweyFactory.getUsers();
			    		},
			    		getLinks: function (DeweyFactory) {
			    			return DeweyFactory.getLinks();
			    		}
			    	}
			    })
			    .otherwise({ 
			    	redirectTo: '/'
			    });
			});

			DeweyApp.factory('DeweyFactory', function ($http, $q, $route) {

				var factory = {};

				function getResults () {
					var defer = $q.defer(),
						params = $route.current.params;
					$http.get('/graphs/search.json?query=' + params.query).success(function (response) {

						// prep data
						response = _.map(response, function (obj) {
							var val = obj['title'];
							if (val) {
								obj['first_name'] = val;
								obj['category'] = 'topics';								
							} else {
								obj['category'] = 'users';
							}
							if (!obj['image'])
								obj['image'] = 'picture_placeholder.png';
							if (!obj['department'])
								obj['department'] = 'topic';
							return obj;
						});

						factory.results = response;
						defer.resolve();
					});
					return defer.promise;
				}

				function getUser () {
					var defer = $q.defer(),
						params = $route.current.params;
					$http.get("/users/" + params.userId + ".json").success(function (response) {
						factory.user = response;
						defer.resolve();
					});
					return defer.promise;
				}

				function getUsers () {
					var defer = $q.defer(),
						params = $route.current.params;
					$http.get('/topics/' + params.topicId + '/users.json').success(function (response) {

						// prep data
						response = _.map(response, function (obj) {
							if (obj['title']) {
								obj['category'] = 'topics';								
							} else {
								obj['category'] = 'users';
							}
							console.log(obj);
							return obj;
						});

						factory.results = response;
						defer.resolve();
					});
					return defer.promise;
				}

				function getTopic () {
					var defer = $q.defer(),
						params = $route.current.params;
					$http.get('/topics/' + params.topicId + '.json').success(function (response) {
						factory.topic = response;
						defer.resolve();
					});
					return defer.promise;
				}

				function getTopics () {
					var defer = $q.defer(),
						params = $route.current.params;
					$http.get('/users/' + params.userId + '/topics.json').success(function (response) {
						factory.topics = response;
						defer.resolve();
					});
					return defer.promise;
				}

				function getLinks () {
					var defer = $q.defer(),
						params = $route.current.params;
						source = '';
						id = 0;
						if(params.topicId){
							source = '/topics/';
							id = params.topicId;
						}else{
							source = '/users/';
							id = params.userId;
						}
					$http.get(source + '' + id + '/most_connected.json').success(function (response) {
						factory.nodes_links = response;
						console.log("source: " + source);
						console.log(factory.nodes_links);
						defer.resolve();
					});
					return defer.promise;
				}

				factory.getResults = getResults;
				factory.getUser = getUser;
				factory.getUsers = getUsers;
				factory.getTopic = getTopic;
				factory.getTopics = getTopics;
				factory.getLinks = getLinks;
			  return factory;
			});

			DeweyApp.controller('DeweyController', function ($scope, $location, DeweyFactory) {

				function init () {
					$scope.results = DeweyFactory.results;
					$scope.user = DeweyFactory.user;
					$scope.topic = DeweyFactory.topic;
					$scope.topics = DeweyFactory.topics;
					$scope.nodes_links = DeweyFactory.nodes_links;
					$scope.loginData = {};
					$scope.queryData = {};
				}

			  $scope.login = function () {
			  	$.post('/session/post_login', { 
			  		email: $scope.loginData.email, 
			  		password: $scope.loginData.password ,
			  	}).done(function(response) {
            $scope.$apply(function() {
  		  	    $location.path('/search');
            });
          }).fail(function(response) {
            alert("Invalid Socialcast email and password - please retry.");
          });
			  };

				$scope.search = function () {
					if (event.keyCode == 13) {
						$location.path('/search/' + $scope.queryData.query);
					}
				};

				(function () {
					init();
				})();

			});
		</script>

	</body>
</html>
